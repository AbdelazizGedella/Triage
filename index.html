<!DOCTYPE html>
<html>
<head>
  <title>Hospital Management System</title>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
  <!-- Include Moment.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <!-- Include Moment Timezone -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
</head>
<body>
  <h1>Hospital Management System</h1>
  <!-- Toggle Dark Mode Button -->

  <!-- Navigation -->
  <nav>
    <ul>
      <li><a href="#reception-desk">Reception Desk</a></li>
      <li><a href="#triage-panel">Triage Nurse Panel</a></li>
      <li><a href="#floor-manager">Floor Manager Dashboard</a></li>
    </ul>
  </nav>
  <!-- Reception Desk Interface -->
  <div id="reception-desk" class="container">
    <h2 class="mb-4">Nursing Reception Desk C2/P3</h2>
    <form id="patient-form">
      <div class="form-group">
        <label for="serialNumber">Serial Number:</label>
        <input type="text" class="form-control" id="serialNumber" required>
      </div>
      <div class="form-group">
        <label for="name">Name:</label>
        <input type="text" class="form-control" id="name" required>
      </div>
      <div class="form-group">
        <label for="complaint">Chief Complaint:</label>
        <input type="text" class="form-control" id="complaint" required>
      </div>
      <div class="form-group">
        <label for="score">Visual Triage Score:</label>
        <input type="number" class="form-control" id="score" required>
      </div>
      <div class="form-group">
        <label>Arrival Method:</label><br>
        <button type="button" class="btn btn-outline-primary" onclick="setArrivalMethod('Self')">Self</button>
        <button type="button" class="btn btn-outline-secondary" onclick="setArrivalMethod('Red Crescent')">Red Crescent</button>
        <input type="hidden" id="arrivalMethod" required>
        <div class="invalid-feedback" id="arrivalMethodFeedback">Please select an arrival method.</div>
      </div>
      <button type="button" class="btn btn-danger" onclick="setCriticalAlert()">Critical Alert</button>
      <button type="submit" class="btn btn-primary">Submit</button>
    </form>
  </div>
  <!-- Triage Nurse Interface -->
  <div id="triage-panel">
    <h2>Triage Nurse Panel</h2>
    <div id="patient-queue" class="container-fluid">
      <div class="row"></div>
    </div>
  </div>


    <!-- Dashboard Interface -->
    <div id="dashboard" class="container my-5">
      <div class="row">
        <div class="col-md-4">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">Total Visits</h5>
              <p class="card-text" id="total-visits">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">Registered</h5>
              <p class="card-text" id="registered">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">Self Arrivals</h5>
              <p class="card-text" id="self-arrivals">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">Red Crescent Arrivals</h5>
              <p class="card-text" id="red-crescent-arrivals">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">Waiting Status</h5>
              <p class="card-text" id="waiting-status">0</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  <!-- Floor Manager Dashboard -->
  <div id="floor-manager" class="container">
    <h2>Floor Manager Dashboard</h2>
    <div class="table-responsive">
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>Serial Number</th>
            <th>Name</th>
            <th>Chief Complaint</th>
            <th>Status</th>
            <th>Arrival Time</th>
            <th>Assigned Nurse</th>
            <th>Nurse Assigned At</th>
            <th>Assigned Physician</th>
            <th>Physician Assigned At</th>
            <th>CTAS</th>
            <th>Visual Triage Score</th>
          </tr>
        </thead>
        <tbody id="overall-queue">
        </tbody>
      </table>
    </div>
  </div>
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD4pCW2Js7b5MdwFfSJu1PF95yXiy90wj8",
      authDomain: "hospital-management-8e646.firebaseapp.com",
      projectId: "hospital-management-8e646",
      storageBucket: "hospital-management-8e646.appspot.com",
      messagingSenderId: "473973806686",
      appId: "1:473973806686:web:d0ef14f0847616a1d9c6cf"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    // Reception Desk Logic
    let selectedArrivalMethod = '';

function setArrivalMethod(method) {
  selectedArrivalMethod = method;
  document.getElementById('arrivalMethod').value = method;
  document.querySelectorAll('.btn-outline-primary, .btn-outline-secondary').forEach(button => {
    button.classList.remove('active');
  });
  if (method === 'Self') {
    document.querySelector('.btn-outline-primary').classList.add('active');
  } else {
    document.querySelector('.btn-outline-secondary').classList.add('active');
  }
  document.getElementById('arrivalMethodFeedback').style.display = 'none';
}

document.getElementById('patient-form').addEventListener('submit', function(e) {

  if (!selectedArrivalMethod) {
      e.preventDefault();
      document.getElementById('arrivalMethodFeedback').style.display = 'block';
    }
  e.preventDefault();
  var serialNumber = document.getElementById('serialNumber').value;
  var name = document.getElementById('name').value;
  var complaint = document.getElementById('complaint').value;
  var score = document.getElementById('score').value;
  var arrivalMethod = selectedArrivalMethod;
  var arrivalTime = moment().tz("Asia/Riyadh").format();

  db.collection("patients").add({
    serialNumber: serialNumber,
    name: name,
    chiefComplaint: complaint,
    visualTriageScore: score,
    arrivalMethod: arrivalMethod,
    arrivalTime: arrivalTime,
    status: 'waiting'
  })
  .then(function() {
    console.log("Patient added successfully");
    alert('Patient added to the queue');
    document.getElementById('patient-form').reset();
    selectedArrivalMethod = '';
    document.querySelectorAll('.btn-outline-primary, .btn-outline-secondary').forEach(button => {
      button.classList.remove('active');
    });
    updateDashboard();

  })
  .catch(function(error) {
    console.error("Error adding patient: ", error);
  });
});


function setCriticalAlert() {
      document.getElementById('serialNumber').value = 'Unknown';
      document.getElementById('name').value = 'Unknown';
      document.getElementById('complaint').value = 'Unstable';
      document.getElementById('score').value = '5';
      setArrivalMethod('Red Crescent');
      document.getElementById('patient-form').dispatchEvent(new Event('submit', { 'bubbles': true }));
    }


function updateDashboard() {
  db.collection("patients").get().then((querySnapshot) => {
    let totalVisits = 0;
    let selfArrivals = 0;
    let redCrescentArrivals = 0;
    let waitingStatus = 0;
    let registeredStatus = 0;

    querySnapshot.forEach((doc) => {
      totalVisits++;
      
      const patient = doc.data();
      if (patient.arrivalMethod === 'Self') {
        selfArrivals++;
      } else if (patient.arrivalMethod === 'Red Crescent') {
        redCrescentArrivals++;
      }
      if (patient.status === 'waiting') {
        waitingStatus++;
      }
      if (patient.registrationStatus === 'yes') {
        registeredStatus++;
      }
    });

    document.getElementById('total-visits').textContent = totalVisits;
    document.getElementById('self-arrivals').textContent = selfArrivals;
    document.getElementById('red-crescent-arrivals').textContent = redCrescentArrivals;
    document.getElementById('waiting-status').textContent = waitingStatus;
    document.getElementById('registered').textContent = registeredStatus;
  });
}

    updateDashboard();



    // Triage Nurse Panel Logic
    db.collection("patients").where("status", "in", ["waiting", "nurse_assigned", "physician_assigned", "ctas_assigned"])
    .onSnapshot(function(querySnapshot) {
      var queue = document.getElementById('patient-queue').querySelector('.row');
      queue.innerHTML = ''; // Clear previous content

      if (!querySnapshot.empty) {
        querySnapshot.forEach(function(doc) {
          var patient = doc.data();
          var nurseAssignedAt = patient.nurseAssignedAt ? moment(patient.nurseAssignedAt).tz("Asia/Riyadh").format('YYYY-MM-DD HH:mm:ss') : 'N/A';
          var physicianAssignedAt = patient.physicianAssignedAt ? moment(patient.physicianAssignedAt).tz("Asia/Riyadh").format('YYYY-MM-DD HH:mm:ss') : 'N/A';

          var patientDiv = document.createElement('div');
          patientDiv.className = 'col-md-4 col-sm-6 col-12';
          if (patient.chiefComplaint === 'Unstable') {
        patientDiv.classList.add('unstable-bg');
      }else
      if (patient.visualTriageScore >= 4) {
        patientDiv.classList.add('respiratory');
      } else {
        patientDiv.classList.add('non-respiratory');
      }
          patientDiv.innerHTML = `
            <div class="card mb-3">
              <div class="card-body">
                <p><strong>${patient.serialNumber} | Arrival Method : ${patient.arrivalMethod}</strong></p>
                <p>Arrival Time: ${moment(patient.arrivalTime).tz("Asia/Riyadh").format('YYYY-MM-DD HH:mm:ss')}</p>
                <p>VT: ${patient.visualTriageScore}</p>
                <p>Patient Name: ${patient.name}<br>Chief Complaint: ${patient.chiefComplaint}</p>
                <label for="nurse-${doc.id}">Assign Nurse: </label>
                <input type="text" id="nurse-${doc.id}" required>
                <button class="btn btn-primary btn-sm" onclick="assignNurse('${doc.id}')">Assign Nurse</button> - ${patient.assignedNurse || ''} : ${nurseAssignedAt}<br>
                <label for="physician-${doc.id}">Assign Physician:</label>
                <input type="text" id="physician-${doc.id}" required>
                <button class="btn btn-primary btn-sm" onclick="assignPhysician('${doc.id}')">Assign Physician</button> - ${patient.assignedPhysician || ''} : ${physicianAssignedAt}<br>
                <label for="ctas-${doc.id}">CTAS Level:</label>
                <input type="number" id="ctas-${doc.id}" min="1" max="5" required>
                <button class="btn btn-primary btn-sm" onclick="assignCTAS('${doc.id}')">Assign CTAS Level</button> - ${patient.ctas}<br>
                <label for="registered-${doc.id}">Registered:</label>
                <select id="registered-${doc.id}">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="assignRegistration('${doc.id}')">Update Registration</button><br>
              </div>
            </div>
          `;
          queue.appendChild(patientDiv);
        });
      } else {
        console.log("No patients in the queue.");
        queue.innerHTML = '<p>No patients in the queue.</p>';
      }
    });

    function assignNurse(patientId) {
      var nurseId = document.getElementById(`nurse-${patientId}`).value;
      var timestamp = new Date().toISOString();
      db.collection("patients").doc(patientId).update({
        assignedNurse: nurseId,
        nurseAssignedAt: timestamp,
        status: 'nurse_assigned'
      })
      .then(function() {
        console.log("Nurse assigned successfully");
      })
      .catch(function(error) {
        console.error("Error assigning nurse: ", error);
      });
    }

    function assignPhysician(patientId) {
      var physicianId = document.getElementById(`physician-${patientId}`).value;
      var timestamp = new Date().toISOString();
      db.collection("patients").doc(patientId).update({
        assignedPhysician: physicianId,
        physicianAssignedAt: timestamp,
        status: 'physician_assigned'
      })
      .then(function() {
        console.log("Physician assigned successfully");
      })
      .catch(function(error) {
        console.error("Error assigning physician: ", error);
      });
    }

    function assignCTAS(patientId) {
      var ctasLevel = document.getElementById(`ctas-${patientId}`).value;
      db.collection("patients").doc(patientId).update({
        ctas: ctasLevel,
        status: 'ctas_assigned'
      })
      .then(function() {
        console.log("CTAS level assigned successfully");
      })
      .catch(function(error) {
        console.error("Error assigning CTAS level: ", error);
      });
    }

    function assignRegistration(patientId) {
      var registeredStatus = document.getElementById(`registered-${patientId}`).value;
      var newStatus = registeredStatus === 'yes' ? 'registered' : 'waiting';
      db.collection("patients").doc(patientId).update({
        registrationStatus: registeredStatus,
        status: newStatus
      })
      .then(function() {
        console.log("Registration status updated successfully");
      })
      .catch(function(error) {
        console.error("Error updating registration status: ", error);
      });
    }

    // Function to determine the CSS class based on status
    function getStatusClass(status) {
      switch (status) {
        case 'ctas_assigned':
          return 'status-ctas_assigned';
        case 'nurse_assigned':
          return 'status-nurse_assigned';
        case 'waiting':
        default:
          return 'status-waiting';
      }
    }

    // Floor Manager Dashboard Logic
    db.collection("patients")
  .onSnapshot(function(querySnapshot) {
    var overallQueue = document.getElementById('overall-queue');
    overallQueue.innerHTML = ''; // Clear previous content

    if (!querySnapshot.empty) {
      querySnapshot.forEach(function(doc) {
        var patient = doc.data();

        var arrivalTime = moment(patient.arrivalTime).tz("Asia/Riyadh");
        var nurseAssignedAt = patient.nurseAssignedAt ? moment(patient.nurseAssignedAt).tz("Asia/Riyadh") : null;
        var physicianAssignedAt = patient.physicianAssignedAt ? moment(patient.physicianAssignedAt).tz("Asia/Riyadh") : null;

        var patientRow = document.createElement('tr');
        patientRow.innerHTML = `
          <td>${patient.serialNumber || 'N/A'}</td>

        <td>${patient.name}</td>
          <td>${patient.chiefComplaint}</td>
          <td>${patient.status}</td>
          <td>${arrivalTime.format('YYYY-MM-DD HH:mm:ss')}</td>
          <td>${patient.assignedNurse || 'N/A'}</td>
          <td>${nurseAssignedAt ? nurseAssignedAt.format('YYYY-MM-DD HH:mm:ss') : 'N/A'}</td>
          <td>${patient.assignedPhysician || 'N/A'}</td>
          <td>${physicianAssignedAt ? physicianAssignedAt.format('YYYY-MM-DD HH:mm:ss') : 'N/A'}</td>
          <td>${patient.ctas || 'N/A'}</td>
          <td>${patient.visualTriageScore || 'N/A'}</td>
        `;
        overallQueue.appendChild(patientRow);
      });
    } else {
      console.log("No patients in the database.");
      overallQueue.innerHTML = '<tr><td colspan="11">No patients in the database.</td></tr>';
    }
  });

  </script>
</body>
</html>
